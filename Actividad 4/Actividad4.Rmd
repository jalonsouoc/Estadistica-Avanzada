---
title: "Actividad 4 - Análisis de la varianza y repaso del curso"
author: "Jorge Alonso Hernández"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output: 
  html_document: 
    toc: yes
    toc_depth: 2
  pdf_document: 
    toc: yes
    toc_depth: 2
    latex_engine: xelatex
classoption: a4paper
---

# 1 Introducción

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carga de librerías
if (!require('stringr')) install.packages('stringr'); library('stringr')
if (!require('plyr')) install.packages('plyr'); library('plyr')
if (!require('nortest')) install.packages('nortest'); library('nortest')
````

# 2 Lectura del archivo y preparación de los datos

Realizamos la carga del fichero de datos. En este caso nos encontramos con un fichero txt con lo que emplearemos la función en R read.table, emplearemos una variable ruta_txt para almacenar la ruta del fichero con los datos. Dicha ruta la obtenemos con la función en R file.choose.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ruta_txt <- "C:\\Users\\Jorge\\Documents\\Rstudio Workspace\\Estadística Avanzada\\Actividad 4\\CensusIncomedata.txt"
adult <- read.table(ruta_txt, header = TRUE)
````

Vemos los tipos de datos con los que han sido cargadas las variables.

````{r echo=TRUE, message=FALSE, warning=FALSE}
str(adult)
````

Vemos que casi todas son de tipo cadena a excepción de age, education_num y hours_per_week que son de tipo entero y de la variable income que es de tipo numérica.


vemos el resumen de la muestra de datos.

````{r echo=TRUE, message=FALSE, warning=FALSE}
summary(adult)
````

Del resumen podemos destacar que la edad mínima es de 17 años y la edad máxima de 90 años. También podemos observar que el salario mínimo está en 22540 € anuales y el máximo en 68370 € anuales.

Por último observamos un apequeña muestra de los datos del conjunto de datos.

````{r echo=TRUE, message=FALSE, warning=FALSE}
head(adult)
````

## 2.1 Preparación de los datos

Inicialmente comprobaremos la existencia de valores perdidos o valores nulos

````{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(is.na(adult))
colSums(adult == "")
````

Comprobamos que no existen valores perdidos o vacíos en nuestra muestra de datos. Una vez realizada esta comprobación eliminaremos los espacios en blanco iniciales de las variables categóricas para obtener una muestra de mayor calidad.

````{r echo=TRUE, message=FALSE, warning=FALSE}

# Patrón para reemplazar los espacios en blanco iniciales
patron <- "^\\s+"
# Valor a sustituir por los espacios en blanco
sust <- ""

# Reemplazamos en las variables categóricas
adult$sex <- str_replace_all(adult$sex, pattern = patron, sust)
adult$workclass <- str_replace_all(adult$workclass, pattern = patron, sust)
adult$marital_status <- str_replace_all(adult$marital_status, pattern = patron, sust)
adult$occupation <- str_replace_all(adult$occupation, pattern = patron, sust)
adult$race <- str_replace_all(adult$race, pattern = patron, sust)

````

Corregimos el nombrede la séptima variable de forma que pase de llamarse "sex" a llamarse "gender".

````{r echo=TRUE, message=FALSE, warning=FALSE}
adult = rename(adult, c(sex="gender")) 
names(adult)
````

Podemos ver que se realiza correctamente la modificación del nombre de la variable.

Comprobamos ahora la normalidad de la variable salario.

````{r echo=TRUE, message=FALSE, warning=FALSE}
# Histograma
hist(adult$income)

#Gráfico de densidad
plot(density(adult$income))
````

Vemos que los datos tienen una densidad asimétrica, empleamos el test de Lilliefors para comprobar la normalidad de la variable

````{r echo=TRUE, message=FALSE, warning=FALSE}
lillie.test(adult$income)
````

Vemos que el p-valor es menor de 0.05 por lo tanto vemos que los datos del salario no siguen una distribución normal.

Creamos una nueva variable dicotómica denominada "Less50"  de forma que calificaremos binariamente el salario. Dicha variable tomará el valor 1 cuando el salario anual sea inferior a 50000 € y el valor 0 en caso contrario.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
adult$Less50 <- -1
# Variable clasificatoria
limit <- 50

for (i in 1:length(adult$Less50)) {
  adult$Less50[i] <- ifelse(adult$income[i] < limit, 1, 0)
}

#Convertimos a tipo entero
adult$Less50 <- as.integer(adult$Less50)

head(adult)

levels(factor(adult$race))
````

Comprobamos que se ha generado correctamente la nueva variable con los valores establecidos

## 2.2 Análisis visual

Mostramos los diagramas de caha de la variable income en función del resto de variables cualitativas.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(formula = income  ~ gender, data = adult, main = "income en función de gender")
````

Se puede apreciar como los salarios son mayores en hombres que en mujeres.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(formula = income  ~ race, data = adult, main = "income en función de race")
````

En este caso podemos apreciar que los salarios de las personas de raza blanca son mayores que los del resto de razas.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(formula = income  ~ workclass, data = adult, main = "income en función de workclass")
````

En cuanto al perfil laboral s eobserva que los salarios mayores se encuentran en los trabajadores gubernamentales.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(formula = income  ~ marital_status, data = adult, main = "income en función de marital_status")
````

Podemos observar que los salarios más altos se pueden encotnrar en las personas casadas.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
boxplot(formula = income  ~ occupation, data = adult, main = "income en función de occupation")
````

Por último vemos que los trabajadores con un mayor salario se encuentran en los denominados trabajadores de cuello blanco que hace referencia a llos trabajadores que realizan trabajos semiprofesionales o profesionales de oficina, administración y coordinación de ventas.

Observamos las variables cuantitativas.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
hist(adult$age, main = "Age")
````

Observamos que las edades predominantes se encuentran entre los 20 y 40 años.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
hist(adult$hours_per_week, main = "Hours per week")
````

Para la shoras semanales podemos observar que la gran mayoría se encuentra entre las 35 y las 40 horas semanales

`````{r echo=TRUE, message=FALSE, warning=FALSE}
hist(adult$education_num, main = "Education num")
````

Por último observamos que el número de años de formación educativa predominanate es el de 9 años.

# 3 Estadística inferencial

## 3.1 Contraste de hipótesis

Para realizar los contrastes de hipótesis obtenemos por un lado las muestras de los salarios para hombres y para mujeres y por otro lado las muestras de los salarios de los grupos raciales blanco y negro

`````{r echo=TRUE, message=FALSE, warning=FALSE}
# Por género
woman <- adult$income[adult$gender == "Female"]
man <- adult$income[adult$gender == "Male"]

# Por raza
black <- adult$income[adult$race == "Black"]
white <- adult$income[adult$race == "White"]
````

### 3.1.1 Hipótesis nula y alternativa

Definimos la hipótesis nula y alternativa por género:

* **Hipótesis nula:** el promedio salarial anual de los hombres es igual al promedio salarial anual de las mujeres
                                                  $$H_O: µ_1 = µ_2$$
* **Hipótesis alternativa:** el promedio salarial anual de los hombres es mayor que el promedio salarial anual de las mujeres
                                                  $$H_1: µ_1 > µ_2$$
Definimos la hipótesis nula y alternativa por raza

* **Hipótesis nula:** el promedio de la diferencia salarial anual de la gente blanca y la gente negra es 6450€
                                                  $$H_0: µ_d = 6450$$
* **Hipótesis alternativa:** el promedio salarial de la diferencia del salario anual de la gente blanca y negra es mayor que 6450€
                                                  $$H_1: µ_d > 6450$$

### 3.1.2 Justificación del test a aplicar

Para la pregunta según el género se va a emplear un contraste de hipótesis de dos muestra emparejadas sobre la media del salario anual y unilateralemnte por la derecho dado que se pretende comprobar si el salario anual de los hombres es mayor al de las mujeres.

Para la pregunta según la raza se va a emplear un contraste de hipótesis sobre dos muestras emparejadas, una para cada raza, aplicado sobre la diferencia de la media salarial anual y unilateralmente por la derecha dado que se pretende comprobar si el salario promedio de la gente blanca es al menos 6450 € mayor que el de la gente de raza negra.

### 3.1.3 Aplicación, interpretación y comprobación del test

**Por el género**

Inicialmente realizamos los cálculos para la pregunta por el género. Debemos derealizar el test de homocedasticidad para comprobar si las varianzas son iguales o diferentes.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
alfa <- 1 - 0.95
H <- man
D <- woman
mean1 <- mean(H)
n1 <- length(H)
s1 <- sd(H)
mean2 <- mean(D)
n2 <- length(D)
s2 <- sd(D)
fobs <- s1^2/s2^2
fcritL <- qf(alfa, df1=n1-1, df2=n2-2)
fcritU <- qf(1 - alfa, df1=n1-1, df2=n2-2)
pvalue <- min(pf(fobs, df1=n1-1, df2=n2-2, lower.tail=FALSE), pf(fobs, df1=n1-1, df2=n2-2))*2
c(mean1, mean2, s1, s2, n1, n2)
c(fobs, fcritL, fcritU, pvalue)
````

Dado que el p valor es inferior al alfa definido de 0.05 podemos asumir que las varianzas son diferentes por lo tanto aplicaremos el estadístco del contraste de dos muestras sobre la media con varianzas desconocidas diferentes.

`````{r echo=TRUE, message=FALSE, warning=FALSE}
alfa <- 1-0.95
dfMean = mean1 -mean2
v <- ((s1^2/n1)+(s2^2/n2))^2 / (((s2^2/n1)^2/(n1-1)) + ((s2^2/n2)^2/(n2-1)))

tobs <- dfMean/sqrt((s1^2/n1 + s2^2/n2))
tcrit <- qt(alfa, v)
pvalue <- pt(abs(tobs), df=v, lower.tail=FALSE)*2
c(tobs, tcrit, pvalue)
````

Podemos ver que el valor observado es de 194.106, el valor crítico es -1.6449 y el p-valor es 0.

Dado que hemos obtenido un valor inferior al alfa definido de 0.05 podemos rechazar la hipótesis nula de que l promedio salarial anual de los hombres es igual a l promedio salarial anual de las mujeres, por lo que se acepta la hipótesis alternativa  de que el promedio salarial anual de los  hombres es superior al de las mujeres.

Rrealizamos las comprobaciones mediante las funciones de R. Inicialmente realizamos la comprobación del test de homocedasticidad con la función var.test.

`````````{r echo=TRUE, message=FALSE, warning=FALSE}
var.test(H,D)
````
Comprobamos que el p valor devuelto en la función también es inferior a 0.05 por lo que son varianzas desconocidas diferentes
Realizamos la comprobación del contraste de hipótesis empleando la función R t.test.

`````````{r echo=TRUE, message=FALSE, warning=FALSE}
t.test(H,D)
````

De nuevo se observa que el p valor devuelto es inferior al alfa definido por lo que comprobamos que se rechaza la hipótesis nula.

**Por el caso racial**

Realizamos ahora los cálculos para la preunta según el caso racial. Para este caso aplicamos los cálculos relativos al contraste de hipótesis de dos muestras emparejadas sobre la media.

````{r echo=TRUE, message=FALSE, warning=FALSE}
#d <- white - black

#mean <- mean(d)
#s <- sd(d)
#n <- length(d)

#tobs <- (mean - 6450)/(s/sqrt(n))
#tcrit <- qt(alfa, df=n-1)
#pvalue <- pt(tobs, lower.tail=FALSE, df=n-1)
#c(tobs, tcrit, pvalue)
````



Realizamos la comprobación utilizando la función de R t.test.

````{r echo=TRUE, message=FALSE, warning=FALSE}
#t.test(white, black, paired=TRUE, alternative="greater", mu=6450)
````
# 4 Modelo de regresión lineal

## 4.1 Estimación de modelos

Creamos un modelo de regresión lineal míltiple empleando la variable dependiente Income y las variables explicativas age,education_num, hours_per_week y gender. Para la creación del modelo empleamos la función en R lm().

Antes de generar el modelo debemos de crear 

````{r echo=TRUE, message=FALSE, warning=FALSE}
modelo1 <- lm(formula = adult$income ~ adult$age + adult$education_num + adult$hours_per_week + adult$gender, na.action = na.exclude)
summary(modelo1)
````

El modelo resultante para obtener la variable income es:

````
income = 31.315777 + 0.082515 * age + 0.446817 * education_num + 0.073834 * hours_per_week + 10.108404 * Male
````

Obtenemos un segundo modelo añadiendo al anterior la variable race.

````{r echo=TRUE, message=FALSE, warning=FALSE}
modelo2 <- lm(formula = adult$income ~ adult$age + adult$education_num + adult$hours_per_week + adult$gender + adult$race, na.action = na.exclude)
summary(modelo2)
````


El modelo resultante es el siguiente

````
income = 26.183312 + 0.078247 * age + 0.419036 * education_num + 0.071274 * hours_per_week + 9.780936 * Male -0.214519 * Asian_pac_Islander + 2.382315 * Black - 3.562672 * Other + 6.681488 * White
````


## 4.2 Interpretación de los modelos

## 4.3 Análisis de residuos

````{r echo=TRUE, message=FALSE, warning=FALSE}
plot(modelo2$fitted.values, modelo2$residuals)
````

````{r echo=TRUE, message=FALSE, warning=FALSE}
qqplot(modelo2$residuals, adult$income)
````

## 4.4 Predicción

Realizamos el cálculo en función del modelo obtenido en el primer apartado.

````
income = 26.183312 + 0.078247 * age + 0.419036 * education_num + 0.071274 * hours_per_week + 9.780936 * Male -0.214519 * Asian_pac_Islander + 2.382315 * Black - 3.562672 * Other + 6.681488 * White
````

Aplicamos osbre las variables los valores especificados en el enunciado.

````{r echo=TRUE, message=FALSE, warning=FALSE}
income <- 26.183312 + 0.078247 * 24 + 0.419036 * 4 + 0.071274 * 40 + 9.780936 * 0 - 0.214519 * 0 + 2.382315 * 1 - 3.562672 * 0 + 6.681488 * 0
income
````

Obtenemos que el salario anual sería de 34.970 € 


# 5 Regresión logística

## 5.1 Generación de los conjuntos de entrenamiento de test

## 5.2 Modelo predictivo

## 5.3 Interpretación

## 5.4 Matriz de confusión

## 5.5 Predicción

# 6 Análisis de la varianza (ANOVA) de un factor

## 6.1 Visualización

## 6.2 Modelo ANOVA

# 7 ANOVA multifactorial

## 7.1 Estudio visual de la interacción

# 8 Conclusiones